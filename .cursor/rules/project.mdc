---
description: Project-wide coding standards and structure
alwaysApply: true
---

# Dickobrazz Server Rules

## Project Overview
- Backend API for Dickobrazz (dickobrazz.com), a Telegram bot with daily size, leaderboards, seasons, achievements, and analytics.
- Stack: Bun (stable), TypeScript (strict), Bun.serve, MongoDB 8.2.3 (mongoose), Redis 8.4 (Bun.redis), Zod, YAML+dotenv, Biome, prom-client, Random.org (@randomorg/core) + crypto.getRandomValues fallback (urandom).

## Project Structure
- `.devcontainer` dev containers and config; `.github` CI; `.vscode` editor settings.
- `app` source root.
- `app/cmd` server entry, router, request context, lifecycle.
- `app/cfg` configuration loading (yaml + env).
- `app/db` Mongo/Redis connections.
- `app/dto` API DTOs and validation schemas.
- `app/log` structured logger.
- `app/net` handlers, middleware, pagination, responses.
- `app/rep/mongo` Mongo models, indexes, aggregations, queries.
- `app/rep/redis` Redis access layer.
- `app/rep/random` Random.org API client and request wrappers.
- `app/svc` service layer:
  - `auth` login/validation
  - `users` profile and privacy
  - `cocks` sizes, leaderboards, dynamics, seasons, achievements
  - `metrics` Prometheus export
  - `health` health checks
  - `random` randomness orchestration (Random.org primary, TSNG/crypto fallback (urandom))
- `app/stt` Prometheus metrics registration/expose.
- `app/sys` system utilities (time, errors, helpers (e.g work with base64)).

## Core Rules
- Use Bun native APIs where possible (Bun.serve, Bun.file).
- In Bun.serve, return Response.json({ data }) directly (no manual Content-Type).
- Write to stdout via `Bun.write(Bun.stdout, "")`.
- Redis: use built-in `Bun.redis` only; do not add Redis dependencies.
- MongoDB: use mongoose only.
- Dependencies: add via `bun add`; run scripts via `bun run`.
- Logging: log starts, stops, connections, errors, and successful operations.
- All functions must be typed; avoid `any`.
- Operations use Moscow time (Europe/Moscow, UTC+3).
- Keep files small and LLM-friendly; single responsibility per file/function.
- No comments unless logic is non-obvious; comments can be in Russian.
- Avoid classes; prefer functional style.
- Prefer one-liner routes and small, single-purpose functions.
- Use `using` for resource lifecycle where possible.
- Avoid polymorphism in hot paths; prefer stable object shapes (const objects).
- Prefer returning tuples from services instead of try/catch-heavy flows.
- Route error handling through Bun.serve error handler, including Zod errors.
- External API calls must use timeouts via AbortController.
- Keep `/metrics` separate for prom-client; do not mix with API logic.
- No Classes: Use functional programming, factory functions, and closures.
- Naming: Brief, descriptive, and consistent.

## Testing & Checks
- After any change, run: `bun run check:fix`, `bun run test`, `bun run typecheck`.
- Write tests for logic that is environment-independent; use `app/cfg/yaml.test.ts` as baseline style.
- Use Russian language in test `it()` descriptions.

## References
- Bun types docs: `node_modules/bun-types/docs/*.md`
